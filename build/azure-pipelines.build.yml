parameters:
  configurations: []

jobs:
- ${{ each configuration in parameters.configurations }}:
  - job: build${{ configuration.buildName }}
    displayName: Build ${{ configuration.name }}
    pool:
      vmImage: ${{ configuration.vmImage }}

    steps:
    - template: azure-pipelines.core.init-dotnet-tools.yml
      parameters:
        vmImage: ${{ configuration.vmImage }}

    - script: |
        dotnet cake build.cake --target=publish --configuration=${{ configuration.name }} --artifacts-directory=$(Build.ArtifactStagingDirectory)
      displayName: Build - Publish

    - task: PublishPipelineArtifact@0
      displayName: Publish - Artifacts
      inputs:
        artifactName: build-${{ configuration.name }}
        targetPath: $(Build.ArtifactStagingDirectory)

    - script: |
        dotnet cake build.cake --target=clean --configuration=${{ configuration.name }} --artifacts-directory=$(Build.ArtifactStagingDirectory)
      displayName: Clean - Build
      condition: always()
