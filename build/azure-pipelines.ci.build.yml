parameters:
  vmImage: ''
  configuration: ''

jobs:
- job: build_${{ parameters.configuration }}
  displayName: Build ${{ parameters.configuration }}
  pool:
    vmImage: ${{ parameters.vmImage }}

  steps:
  - template: azure-pipelines.core.init-dotnet-tools.yml

  - script: |
      export PATH="$PATH:~/.dotnet/tools"
      dotnet cake build.cake --target=publish --configuration=${{ parameters.configuration}} --artifacts-directory=$(Build.ArtifactStagingDirectory)
    displayName: Build - Publish

  - task: PublishPipelineArtifact@0
    displayName: Publish - Artifacts
    inputs:
      artifactName: ci-build
      targetPath: $(Build.ArtifactStagingDirectory)

  - script: |
      export PATH="$PATH:~/.dotnet/tools"
      dotnet cake build.cake --target=clean --configuration=${{ parameters.configuration}} --artifacts-directory=$(Build.ArtifactStagingDirectory)
    displayName: Clean - Build
    condition: always()
